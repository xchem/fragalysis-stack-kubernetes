---

# To 'wipe' we remove: -
# - Stack
#Â - Redis
# - Django secret
# - Database
# And then, unconditionally delete: -
# - Database volume
# - Media volume

- name: Set django secret fact
  # These facts are required to remove the secret...
  set_fact:
    stack_django_secret_key_fact: '{{ stack_django_secret_key }}'
    stack_django_superuser_password_fact: '{{ stack_django_superuser_password }}'

- name: Shutdown stack, and redis
  k8s:
    definition: "{{ lookup('template', '{{ item }}.yaml.j2') }}"
    state: absent
  loop:
  - statefulset-stack
  - statefulset-worker
  - deployment-beat
  - deployment-redis
  - secret-django

- name: Remove media volume
  k8s:
    definition: "{{ lookup('template', 'pvc-media.yaml.j2') }}"
    state: absent
    wait: true
  when: stack_shutdown_remove_media_volume|bool

- name: Shutdown database
  k8s:
    definition: "{{ lookup('template', '{{ item }}.yaml.j2') }}"
    state: absent
    wait: true
  loop:
  - statefulset-database

- name: Remove database volume
  k8s:
    definition: "{{ lookup('template', 'pvc-database.yaml.j2') }}"
    state: absent
    wait: true
  when: stack_shutdown_remove_database_volume|bool
