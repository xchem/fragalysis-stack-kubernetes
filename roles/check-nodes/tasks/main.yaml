---

# Finds all the nodes in the cluster and checks that they are 'Ready'.

- name: Display Ansible version
  debug:
    var: ansible_version.full

- name: Include sensitive variables
  ansible.builtin.include_vars:
    file: sensitive.vault

- name: Check cluster name
  assert:
    that:
    - cluster != 'SetMe'

- name: Get node information
  kubernetes.core.k8s_info:
    kind: Node
    api_key: "{{ k8s_auth[cluster].api_key }}"
    host: "{{ k8s_auth[cluster].host }}"
    validate_certs: "{{ k8s_auth[cluster].verify_ssl | default('no', true) }}"
  register: node_result

- name: Initialise unready nodes fact
  set_fact:
    unready_nodes: []

- name: Check node
  include_tasks: check-node.yaml
  loop: "{{ node_result.resources }}"
  no_log: yes

# Handle unready nodes (always)
# The user will see an alert for nodes that are not Ready
# on every execution of this playbook (typically every 5 minutes).

- name: Handle unready nodes
  when: unready_nodes | length > 0
  block:

  - name: Display unready_nodes fact
    debug:
      var: unready_nodes

  - name: Alert slack channel (unready nodes)
    slack:
      token: "{{ slack_token }}"
      validate_certs: no
      blocks:
      - type: section
        text:
          type: mrkdwn
          text: |
            *Automated alert from the Ansible Node Checker ({{ cluster | upper }} Cluster)*
      - type: section
        text:
          type: mrkdwn
          text: |
            *The following {{ cluster | upper }} cluster nodes are not reported as READY:*
            {% for node in unready_nodes %}
            - {{ node }}
            {% endfor %}
    when: slack_token | length > 0

# Heartbeat (to Slack)
# (if we've said nothing for the defined period)

- name: Heartbeat
  when:
  - unready_nodes | length == 0
  - slack_token | length > 0
  block:

  - name: Check heartbeat file
    ansible.builtin.stat:
      path: "{{ heartbeat_filename }}"
    register: hb_file

  - name: Touch heartbeat file (if not preset)
    ansible.builtin.file:
      path: "{{ heartbeat_filename }}"
      state: touch
    when: not hb_file.stat.exists

  - name: Check for out-of-date heartbeat file
    find:
      paths: .
      file_type: file
      age: "{{ heartbeat_interval_hours }}h"
      patterns: "{{ heartbeat_filename }}"
    register: old_hb_file

  - name: Issue heartbeat message
    when: old_hb_file.matched > 0
    block:

    - name: Issue heartbeat message
      slack:
        token: "{{ slack_token }}"
        validate_certs: no
        blocks:
        - type: section
          text:
            type: mrkdwn
            text: |
              *Automated HEARTBEAT from the Ansible Node Checker*
              - This is only a heartbeat message
              - It is sent to reassure you that the playbook is still running
              - It is sent after every {{ heartbeat_interval_hours }} hours of inactivity

    - name: Touch (old) heartbeat file
      ansible.builtin.file:
        path: "{{ heartbeat_filename }}"
        state: touch
